<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Otra Ciudad</title>
    <link rel="icon" type="image/png" sizes="192x192" href="assets/uploads/favicon-192x192.png">
    <link rel="stylesheet" href="https://use.typekit.net/zhl8vxt.css">
    <link rel="stylesheet" href="css/style.css" />
</head>

<body class="page-home">
    <header class="topbar">
        <div class="topbar__inner">
            <a class="brand" href="/" aria-label="Ir al inicio">
                <picture>
                    <source media="(min-width: 521px)" srcset="/assets/uploads/otraCiudad_03.png" />
                    <img class="brand__logo" src="/assets/uploads/otraCiudad_01.png" alt="Otra Ciudad" />
                </picture>
            </a>

            <nav class="topnav" aria-label="Navegación principal">
                <a href="/about.html">About us</a>
                <a href="/projects.html">Projects</a>
                <a href="/contact.html">Contact us</a>
            </nav>

            <button class="menuBtn" type="button" aria-label="Abrir menú" aria-expanded="false">
                <span class="menuBtn__bar" aria-hidden="true"></span>
                <span class="menuBtn__bar" aria-hidden="true"></span>
                <span class="menuBtn__bar" aria-hidden="true"></span>
            </button>
        </div>
    </header>

    <main class="home">
        <section class="hero" aria-label="Carrusel de imágenes">
            <div class="heroSlider" id="heroSlider">
                <img class="heroSlide is-active" alt="" />
                <img class="heroSlide" alt="" />
            </div>
        </section>

        <section class="band" aria-label="Texto introductorio">
            <div class="band__inner">
                <p class="band__text" id="siteIntro">
                    Cargando información...
                </p>
            </div>
        </section>

        <section class="homeProjects" aria-label="Proyectos destacados">
            <div class="homeProjects__inner" id="homeFeatured">
                <p style="text-align: center; padding: 50px; opacity: 0.5;">Cargando proyectos destacados...</p>
            </div>
        </section>
    </main>

    <script src="/js/hero-carousel.js"></script>

    <script>
        (function () {
            const btn = document.querySelector(".menuBtn");
            const nav = document.querySelector(".topnav");
            if (!btn || !nav) return;

            function closeMenu() {
                document.body.classList.remove("menu-open");
                btn.setAttribute("aria-expanded", "false");
            }

            btn.addEventListener("click", () => {
                const open = !document.body.classList.contains("menu-open");
                document.body.classList.toggle("menu-open", open);
                btn.setAttribute("aria-expanded", String(open));
            });

            // SOLO cerrar menú si el click es en un link del nav
            nav.addEventListener("click", (e) => {
                if (e.target && e.target.tagName === "A") {
                    closeMenu();
                }
            });

            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeMenu();
            });
        })();
    </script>

    <script>
        (function () {
            const mount = document.getElementById("homeFeatured");
            const introEl = document.getElementById("siteIntro");

            // 1. Cargar Información General (Banda Celeste)
            fetch("/content/site.json")
                .then(r => r.json())
                .then(data => {
                    if (data.heroText) introEl.innerText = data.heroText;
                })
                .catch(e => console.error("Error cargando site settings:", e));

            // 2. Cargar Proyectos
            fetch("/content/projects-index.json")
                .then(r => r.json())
                .then(data => {
                    const allProjects = data.projects || [];
                    
                    // Filtrar solo los destacados, o si no hay, mostrar los primeros 4
                    const featured = allProjects.filter(p => p.featured);
                    const projects = featured.length > 0 ? featured.slice(0, 4) : allProjects.slice(0, 4);
                    
                    if (!projects.length) {
                        mount.innerHTML = "<p style='text-align:center;'>No hay proyectos aún. Crea proyectos desde el CMS.</p>";
                        return;
                    }

                    mount.innerHTML = projects.map(p => {
                        const link = `/projects/${p.slug}`;
                        const imgSrc = p.coverImage.startsWith('http') ? p.coverImage : ('/' + p.coverImage);
                        
                        // Usar excerpt si existe, si no usar primeros 150 caracteres de description
                        let desc = '';
                        if (p.excerpt) {
                            desc = p.excerpt;
                        } else if (p.description) {
                            // Eliminar markdown básico y limitar a 150 caracteres
                            const plainText = p.description.replace(/[#*_\[\]]/g, '').trim();
                            desc = plainText.length > 150 ? plainText.substring(0, 150) + '...' : plainText;
                        }
                        
                        return `
                        <div class="homeRow">
                            <article class="projItem">
                                <p class="projItem__desc">${desc}</p>
                                <div class="projItem__row">
                                    <h2 class="projItem__title">
                                        <a href="${link}">${p.title}</a>
                                    </h2>
                                    <p class="projItem__place">${p.location || ''}</p>
                                </div>
                            </article>
                            <div class="imgMask">
                                <a href="${link}">
                                    <img class="stackImg" src="${imgSrc}" alt="${p.title}" />
                                </a>
                            </div>
                        </div>`;
                    }).join('');
                })
                .catch(e => {
                    console.error("Error cargando proyectos:", e);
                    mount.innerHTML = "<p style='text-align:center;'>Error cargando proyectos.</p>";
                });
        })();
    </script>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>
</body>
</html>