<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Projects - Otra Ciudad</title>
    <link rel="icon" type="image/png" sizes="192x192" href="assets/uploads/favicon-192x192.png">
    <link rel="stylesheet" href="https://use.typekit.net/zhl8vxt.css">
    <link rel="stylesheet" href="css/style.css" />
</head>

<body class="page-projects">
    <header class="topbar">
        <div class="topbar__inner">
            <a class="brand" href="/" aria-label="Ir al inicio">
                <picture>
                    <source media="(min-width: 521px)" srcset="/assets/uploads/otraCiudad_03.png" />
                    <img class="brand__logo" src="/assets/uploads/otraCiudad_01.png" alt="Otra Ciudad" />
                </picture>
            </a>

            <nav class="topnav" aria-label="Navegación principal">
                <a href="/about.html">About us</a>
                <a href="/projects.html">Projects</a>
                <a href="/contact.html">Contact us</a>
            </nav>

            <button class="menuBtn" type="button" aria-label="Abrir menú" aria-expanded="false">
                <span class="menuBtn__bar" aria-hidden="true"></span>
                <span class="menuBtn__bar" aria-hidden="true"></span>
                <span class="menuBtn__bar" aria-hidden="true"></span>
            </button>
        </div>
    </header>

    <main class="projects">
        <div class="projects__container">
            <!-- Lista de proyectos se carga dinámicamente -->
            <div id="projectsList" class="projects__list">
                <!-- Los proyectos se cargarán aquí automáticamente desde el CMS -->
            </div>
        </div>
    </main>

    <!-- Script del menú hamburguesa -->
    <script>
        (function () {
            const btn = document.querySelector(".menuBtn");
            const nav = document.querySelector(".topnav");
            if (!btn || !nav) return;

            function closeMenu() {
                document.body.classList.remove("menu-open");
                btn.setAttribute("aria-expanded", "false");
            }

            btn.addEventListener("click", () => {
                const open = !document.body.classList.contains("menu-open");
                document.body.classList.toggle("menu-open", open);
                btn.setAttribute("aria-expanded", String(open));
            });

            // SOLO cerrar si el click es en un link DENTRO del nav
            nav.addEventListener("click", (e) => {
                if (e.target && e.target.tagName === "A") {
                    closeMenu();
                }
            });

            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeMenu();
            });
        })();
    </script>

    <!-- Script para cargar proyectos dinámicamente desde JSON -->
    <script>
        (function () {
            const projectsList = document.getElementById('projectsList');
            
            // Mostrar mensaje de carga
            projectsList.innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Cargando proyectos...</p>';

            // Cargar el índice de proyectos
            fetch('/content/projects-index.json')
                .then(res => {
                    if (!res.ok) throw new Error('No se pudo cargar el índice de proyectos');
                    return res.json();
                })
                .then(data => {
                    // Ordenar proyectos por 'order' si existe
                    const projects = data.projects || data;
                    
                    // Si no hay proyectos, mostrar mensaje amigable
                    if (!projects || projects.length === 0) {
                        projectsList.innerHTML = `
                            <div style="padding: 80px 20px; text-align: center;">
                                <h2 style="font-family: var(--font-title); font-size: 48px; margin: 0 0 20px; font-weight: 800; line-height: 1;">No hay proyectos aún</h2>
                                <p style="font-size: 18px; color: #666; margin: 0;">Los proyectos aparecerán aquí cuando los crees desde el CMS.</p>
                            </div>
                        `;
                        return;
                    }

                    const sortedProjects = projects.sort((a, b) => (a.order || 0) - (b.order || 0));

                    // Generar HTML para cada proyecto
                    projectsList.innerHTML = sortedProjects.map(project => `
                        <a href="/projects/${project.slug}" class="projectCard" data-slug="${project.slug}">
                            <div class="projectCard__imgWrap">
                                <img class="projectCard__img" 
                                     src="/${project.coverImage}" 
                                     alt="${project.title}" />
                            </div>
                            <h2 class="projectCard__title">${project.title}</h2>
                            <div class="projectCard__meta">
                                <span class="projectCard__label">Location:</span>
                                <span class="projectCard__location">${project.location || ''}</span>
                            </div>
                            <div class="projectCard__meta">
                                <span class="projectCard__label">Year</span>
                                <span class="projectCard__year">${project.year || ''}</span>
                            </div>
                        </a>
                    `).join('');

                    // Forzar navegación con JavaScript
                    document.querySelectorAll('.projectCard').forEach(card => {
                        card.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const slug = card.getAttribute('data-slug');
                            window.location.href = `/projects/${slug}`;
                        });
                    });
                })
                .catch(err => {
                    console.error('Error cargando proyectos:', err);
                    projectsList.innerHTML = `
                        <div style="padding: 80px 20px; text-align: center;">
                            <h2 style="font-family: var(--font-title); font-size: 48px; margin: 0 0 20px; font-weight: 800; line-height: 1;">No hay proyectos aún</h2>
                            <p style="font-size: 18px; color: #666; margin: 0;">Crea tu primer proyecto desde el <a href="/admin" style="text-decoration: underline;">CMS</a>.</p>
                        </div>
                    `;
                });
        })();
    </script>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>
</body>

</html>